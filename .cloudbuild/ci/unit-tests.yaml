steps:
  - name: us-docker.pkg.dev/ci-account/teleport/buildbox-root:teleport6.2-v0.1.0
    id: export-bcc-headers
    volumes:
      - name: bcc-include
        path: /bcc-include
    args: [cp, -R, /bcc-include, /workspace/build.assets/bcc]

  - name: us-docker.pkg.dev/ci-account/teleport/buildbox-root:teleport6.2-v0.1.0
    id: reconfigure-for-nonroot-user
    args: ['chown', '-R', 'ci:ci', '/workspace']

  - name: us-docker.pkg.dev/ci-account/teleport/buildbox-nonroot:teleport6.2-v0.1.0
    id: unit-test
    env:
      - TELEPORT_ETCD_TEST="yes"
    volumes:
      - name: bcc-include
        path: /usr/include/bcc
    entrypoint: /bin/bash
    args: 
      - -c
      - (make run-etcd &); sleep 1; make test
    timeout: 15m
    
timeout: 15m
options:
  env: 
    - GOMODCACHE=/workspace/.gomodcacheci
  machineType: 'E2_HIGHCPU_32'
  
